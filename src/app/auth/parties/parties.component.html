<div class="content">
  <div class="container">
    <div class="row">
      <div class="col">
        <h3>Actores</h3>
        <hr />
        <p>
          <b>Actores:</b> Son las partes involucradas en el proceso de
          contratación, como son: el comprador, la Entidad contratante, la
          Entidad financiera, el Área requirente, el Área técnica, el
          Administrador del contrato, el Proveedor, el Licitante, el Emisor del
          pago, la Persona que solicita información, el Receptor del pago, el
          Órgano de revisión y la Institución que expide la garantía.
        </p>
      </div>
    </div>

    <!-- Selección de Actores con Cards -->
    <div class="row mb-4">
      <div class="col">
        <h4>Seleccionar Tipo de Actor</h4>
        <div class="row">
          <div 
            class="col-md-4 col-lg-3 mb-3" 
            *ngFor="let role of rolesList"
          >
            <div 
              class="card h-100 actor-card" 
              (click)="openActorModal(role.code)"
              style="cursor: pointer; transition: all 0.3s ease;"
              [ngClass]="{'border-primary': false}"
            >
              <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">{{ role.title }}</h6>
              </div>
              <div class="card-body d-flex flex-column">
                <p class="card-text small flex-grow-1">{{ role.description }}</p>
                <button 
                  type="button" 
                  class="btn btn-outline-primary btn-sm mt-auto"
                >
                  <i class="fas fa-plus me-1"></i>Agregar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de Actores Existentes -->
    <div class="row">
      <div class="col">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th scope="col">ID</th>
                <th scope="col">Roles</th>
                <th scope="col">Nombre común</th>
                <th scope="col">Cargo</th>
                <th scope="col">Nombre legal</th>
                <th scope="col">Nombre</th>
                <th scope="col">Primer apellido</th>
                <th scope="col">Segundo apellido</th>
                <th scope="col">Opciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of partiesForm.value.parties; index as i">
                <td scope="row">{{ i + 1 }}</td>
                <td>
                  <ul>
                    <li *ngFor="let rol of item.roles">
                      {{ getRoleTitle(rol) }}
                    </li>
                  </ul>
                </td>
                <td>{{ item.name }}</td>
                <td>{{ item.position }}</td>
                <td>{{ item.identifier?.legalName }}</td>
                <td>{{ item.identifier?.givenName }}</td>
                <td>{{ item.identifier?.patronymicName }}</td>
                <td>{{ item.identifier?.matronymicName }}</td>
                <td>
                  <button
                    type="button"
                    class="btn btn-danger btn-delete btn-sm"
                    (click)="confirmAndDeletePartie(i)"
                  >
                    Eliminar
                  </button>
                </td>
              </tr>
              <tr *ngIf="partiesForm.value.parties.length === 0">
                <th scope="row" colspan="9" class="text-center">
                  Sin registros.
                </th>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Dinámica para Actor -->
<div class="modal fade" id="actorModal" tabindex="-1" aria-labelledby="actorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="actorModalLabel">
          <i class="fas fa-user me-2"></i>
          {{ selectedActorTitle }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body">
        <div class="container-fluid">
          <!-- Navegación por pestañas -->
          <ul class="nav nav-tabs" id="actorTabs" role="tablist">
            <!-- Información General (siempre visible) -->
            <li class="nav-item" role="presentation">
              <button 
                class="nav-link active" 
                id="general-tab" 
                data-bs-toggle="tab" 
                data-bs-target="#general" 
                type="button" 
                role="tab"
              >
                Información General
              </button>
            </li>
            
            <!-- Domicilio (condicional) -->
            <li class="nav-item" role="presentation" *ngIf="shouldShowField('address')">
              <button 
                class="nav-link" 
                id="address-tab" 
                data-bs-toggle="tab" 
                data-bs-target="#address" 
                type="button" 
                role="tab"
              >
                Domicilio
              </button>
            </li>
            
            <!-- Puntos de Contacto Adicionales (condicional) -->
            <li class="nav-item" role="presentation" *ngIf="shouldShowField('additionalContactPoints')">
              <button 
                class="nav-link" 
                id="additional-contacts-tab" 
                data-bs-toggle="tab" 
                data-bs-target="#additional-contacts" 
                type="button" 
                role="tab"
              >
                Puntos de Contacto Adicionales
              </button>
            </li>
            
            <!-- Beneficiarios (solo para supplier y tenderer) -->
            <li class="nav-item" role="presentation" *ngIf="shouldShowField('beneficialOwners')">
              <button 
                class="nav-link" 
                id="beneficiaries-tab" 
                data-bs-toggle="tab" 
                data-bs-target="#beneficiaries" 
                type="button" 
                role="tab"
              >
                Beneficiarios
              </button>
            </li>
            
            <!-- Identificadores Adicionales (siempre disponible) -->
            <li class="nav-item" role="presentation">
              <button 
                class="nav-link" 
                id="additional-identifiers-tab" 
                data-bs-toggle="tab" 
                data-bs-target="#additional-identifiers" 
                type="button" 
                role="tab"
              >
                Identificadores Adicionales
              </button>
            </li>
          </ul>

          <!-- Contenido de las pestañas -->
          <div class="tab-content mt-3" id="actorTabsContent">
            <!-- Información General -->
            <div class="tab-pane fade show active" id="general" role="tabpanel">
              <app-parties-general-dynamic
                [selectedActor]="selectedActor"
                [fieldVisibility]="fieldVisibility"
                (saveGeneral)="saveGeneral($event)"
              ></app-parties-general-dynamic>
            </div>
            
            <!-- Domicilio -->
            <div class="tab-pane fade" id="address" role="tabpanel" *ngIf="shouldShowField('address')">
              <app-parties-address
                (saveAddress)="saveAddress($event)"
              ></app-parties-address>
            </div>
            
            <!-- Puntos de Contacto Adicionales -->
            <div class="tab-pane fade" id="additional-contacts" role="tabpanel" *ngIf="shouldShowField('additionalContactPoints')">
              <app-parties-additional-contact-points
                [additionalContactPointsArray]="partieForm.value.additionalContactPoints || []"
                (addAdditionalContactPoints)="addAdditionalContactPoints($event)"
                (deleteAdditionalContactPoints)="deleteAdditionalContactPoints($event)"
              ></app-parties-additional-contact-points>
            </div>
            
            <!-- Beneficiarios -->
            <div class="tab-pane fade" id="beneficiaries" role="tabpanel" *ngIf="shouldShowField('beneficialOwners')">
              <app-parties-beneficial-owners
                [beneficialOwnersArray]="partieForm.value.beneficialOwners || []"
                (addBeneficialOwners)="addBeneficialOwners($event)"
                (deleteBeneficialOwners)="deleteBeneficialOwners($event)"
              ></app-parties-beneficial-owners>
            </div>
            
            <!-- Identificadores Adicionales -->
            <div class="tab-pane fade" id="additional-identifiers" role="tabpanel">
              <div class="container">
                <div class="row">
                  <div class="col">
                    <h4>Identificadores Adicionales</h4>
                    <p class="text-muted">
                      Puede agregar identificadores adicionales para este actor según sea necesario.
                    </p>
                    <button 
                      type="button" 
                      class="btn btn-primary"
                      (click)="showAdditionalIdentifiersSection = !showAdditionalIdentifiersSection"
                    >
                      <i class="fas fa-plus me-2"></i>
                      Agregar Identificadores Adicionales
                    </button>
                    
                    <!-- Sección de identificadores adicionales (mostrar/ocultar) -->
                    <div *ngIf="showAdditionalIdentifiersSection" class="mt-3">
                      <app-additional-identifiers-section
                        [additionalIdentifiersArray]="partieForm.value.additionalIdentifiers || []"
                        (addAdditionalIdentifier)="addAdditionalIdentifier($event)"
                        (deleteAdditionalIdentifier)="deleteAdditionalIdentifier($event)"
                      ></app-additional-identifiers-section>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="button" class="btn btn-success" (click)="saveActor()">
          <i class="fas fa-save me-2"></i>Guardar Actor
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.actor-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.actor-card:hover .card-header {
  background-color: #0056b3 !important;
}

.nav-tabs .nav-link {
  color: #495057;
  border: 1px solid transparent;
}

.nav-tabs .nav-link:hover {
  border-color: #e9ecef #e9ecef #dee2e6;
  color: #0056b3;
}

.nav-tabs .nav-link.active {
  color: #495057;
  background-color: #fff;
  border-color: #dee2e6 #dee2e6 #fff;
}

.modal-xl {
  max-width: 1200px;
}

.btn-delete {
  font-size: 0.875rem;
}
</style>